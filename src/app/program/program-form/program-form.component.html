<ion-grid>
    <form [formGroup]=form (ngSubmit)=onSubmit(form.value)>
        <ion-row>
            <mat-form-field>
                <mat-label>Program Name</mat-label>
                <input matInput type="text" [formControl]="name" name="name"
                       placeholder=""
                       autocomplete="off"
                       enterKeyHint="next"
                       required>
                <mat-error *ngIf="name.hasError('required')">Name is required.</mat-error>
                <mat-error *ngIf="name.hasError('entityIDTaken')">A program named {{name.value}} already exists
                </mat-error>
                <mat-error *ngIf="name.hasError('couldNotReachServer')">Could not reach server. Please check your
                    connection and try again.</mat-error>
                <mat-hint *ngIf="getSlug(name.value).length > 0 && name.enabled">This link will be at
                    /program/{{getSlug(name.value)}}
                </mat-hint>
                <mat-hint *ngIf="name.disabled">Cannot edit the name of an existing program</mat-hint>
            </mat-form-field>
        </ion-row>

        <ion-row>
            <mat-form-field>
                <mat-label>Number of Phases</mat-label>
                <mat-select [formControl]="numberOfPhases">
                    <mat-option [value]="1">1</mat-option>
                    <mat-option [value]="2">2</mat-option>
                    <mat-option [value]="3">3</mat-option>
                    <mat-option [value]="4">4</mat-option>
                    <mat-option [value]="5">5</mat-option>
                </mat-select>
                <mat-error *ngIf="name.hasError('required')">Number of Phases is required.</mat-error>
            </mat-form-field>
        </ion-row>


        <ng-container *ngFor="let phaseControl of phases.controls; let phaseIndex = index">
            <ion-label>
                <h3>Phase {{phaseIndex + 1}}</h3>
            </ion-label>

            <form [formGroup]="phaseControl">

                <mat-form-field>
                    <mat-label>Number of Weeks</mat-label>
                    <input matInput type="number" [formControl]="phaseControl.get('lengthInWeeks')"
                           name="sets"
                           autocomplete="off"
                           enterKeyHint="next">
                </mat-form-field>

                <ion-label>Weekly Schedule</ion-label>
                <ng-container *ngFor="let day of getDayList(); let dayIndex = index">
                    <ng-template let-dayControl [ngTemplateOutletContext]="{ $implicit: getDayControl(day, phaseControl) }" [ngTemplateOutlet]="t" #t>
                        <ion-row>
                            <ion-skeleton-text [hidden]="dayControl.dirty || (workoutList$ | async).length !== 0"></ion-skeleton-text>
                            <mat-form-field [hidden]="(workoutList$ | async).length === 0">
                                <mat-label>Day {{dayIndex + 1}} Workout</mat-label>
                                <mat-select [formControl]="dayControl" [compareWith]="compareWorkouts" [required]="dayIndex === 0"> 
                                    <mat-option *ngFor="let workout of (workoutList$ | async)"
                                                [value]="workout">{{workout.name}}</mat-option>
                                </mat-select>
                                <mat-error *ngIf="dayControl.hasError('required')">A workout is required for Day 1 of the week
                                </mat-error>
                                <mat-hint [hidden]="dayControl.value || day === 'day1'" [align]="'start'">Rest day</mat-hint>
                                <mat-hint class="reset-phase" [align]="'end'"
                                          [hidden]="!dayControl.value"
                                          (click)="resetControl(dayControl)">Reset</mat-hint>
                            </mat-form-field>
                        </ion-row>
                    </ng-template>
                </ng-container>
            </form>
        </ng-container>

        <ion-button type="submit"
                    [disabled]="form.invalid || (requestInProgress$ | async) || !form.touched"
                    expand="full">
            <ion-icon name="calendar-outline"></ion-icon>&nbsp;{{buttonText}}
        </ion-button>
    </form>
</ion-grid>
